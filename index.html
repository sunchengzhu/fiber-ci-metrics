<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fiber Daily Performance Metrics</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 30px;
      background: #f7f9fb;
      color: #222;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 24px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      text-align: center;
    }
    th {
      background: #f2f4f6;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    td:last-child {
      font-weight: 600;
    }
    td.positive {
      color: #008a2e;
    }
    td.negative {
      color: #d43c3c;
    }
  </style>
</head>
<body>
  <h1>üßµ Fiber Daily Performance Metrics</h1>

  <table id="data-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Timestamp (UTC+8)</th>
        <th>FNN Version</th>
        <th>Threads</th>
        <th>TPS</th>
        <th>% Change</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  async function loadData() {
    const url =
      "https://efjpttqncntihjbnvpdi.supabase.co/rest/v1/ci_metrics" +
      "?select=measured_at,measured_date,threads,tps,pct_change,fnn_version" +
      "&order=measured_at.desc" +
      "&apikey=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmanB0dHFuY250aWhqYm52cGRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5ODY3NjIsImV4cCI6MjA3NTU2Mjc2Mn0.tgSuUx82oCi19PRvC4DSZ6cz-Uq6-40cmSjrhYbj2yo";

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const tbody = document.querySelector("#data-table tbody");
      tbody.innerHTML = data
        .map((r) => {
          const dateOnly =
            r.measured_date ||
            new Date(r.measured_at).toISOString().slice(0, 10);
          const timestamp = new Date(r.measured_at).toLocaleString("zh-CN", {
            timeZone: "Asia/Shanghai",
          });
          const fnnVer = r.fnn_version || "‚Äî";
          const pct =
            r.pct_change == null
              ? "‚Äî"
              : (r.pct_change > 0
                  ? `<span class='positive'>+${r.pct_change.toFixed(3)}%</span>`
                  : `<span class='negative'>${r.pct_change.toFixed(3)}%</span>`);
          return `
            <tr>
              <td>${dateOnly}</td>
              <td>${timestamp}</td>
              <td>${fnnVer}</td>
              <td>${r.threads}</td>
              <td>${r.tps.toFixed(2)}</td>
              <td>${pct}</td>
            </tr>`;
        })
        .join("");
    } catch (err) {
      document.body.innerHTML += `<p style="color:red">Error: ${err.message}</p>`;
      console.error(err);
    }
  }

  // ÂàùÊ¨°Âä†ËΩΩ + ÊØè 60 ÁßíËá™Âä®Âà∑Êñ∞
  loadData();
  setInterval(loadData, 60000);
  </script>
</body>
</html>